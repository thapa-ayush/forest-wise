{% extends 'base.html' %}
{% block content %}
<!-- Top Bar -->
<div class="flex items-center justify-between mb-6">
    <!-- Time Filter - Simple Tab Style -->
    <div class="flex items-center gap-1 bg-gray-800/50 rounded-lg p-1">
        <button class="time-tab active" data-view="current">
            <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span>
            Live
        </button>
        <button class="time-tab" data-view="day">Day</button>
        <button class="time-tab" data-view="month">Month</button>
        <button class="time-tab" data-view="year">Year</button>
    </div>

    <!-- Period & Date Picker -->
    <div class="flex items-center gap-3">
        <span id="period-display" class="text-sm text-gray-400">Today</span>
        <input type="date" id="date-picker"
            class="hidden bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm text-white">
        <input type="month" id="month-picker"
            class="hidden bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm text-white">
        <select id="year-picker"
            class="hidden bg-gray-800 border border-gray-700 rounded-lg px-2 py-1 text-sm text-white">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
        </select>
    </div>

    <!-- Status -->
    <div class="flex items-center gap-3">
        <span id="connection-status" class="status-badge online">
            <span class="status-dot"></span>
            Live
        </span>
        <span class="text-sm text-gray-500" id="last-update">Updated just now</span>
    </div>
</div>

<!-- Hidden select for compatibility -->
<select id="view-mode" class="hidden">
    <option value="current">Current (Live)</option>
    <option value="day">Day</option>
    <option value="month">Month</option>
    <option value="year">Year</option>
</select>

<style>
    .time-tab {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        color: #9ca3af;
        transition: all 0.2s;
        display: flex;
        align-items: center;
    }

    .time-tab:hover {
        color: #fff;
        background: rgba(55, 65, 81, 0.5);
    }

    .time-tab.active {
        color: #10b981;
        background: rgba(16, 185, 129, 0.15);
    }
</style>

<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
    <div class="stat-card nodes">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
            </svg>
        </div>
        <div class="stat-label">Active Nodes</div>
        <div class="stat-value" id="node-count">-</div>
    </div>

    <div class="stat-card alerts">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <div class="stat-label" id="alert-label">Alerts</div>
        <div class="stat-value" id="alert-count">-</div>
    </div>

    <div class="stat-card spectrograms">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        </div>
        <div class="stat-label" id="spec-label">Spectrograms</div>
        <div class="stat-value" id="spec-count">-</div>
    </div>

    <div class="stat-card detections">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </div>
        <div class="stat-label" id="chainsaw-label">Chainsaw Detections</div>
        <div class="stat-value" id="chainsaw-count">-</div>
    </div>
</div>

<!-- Main Content Grid -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Recent Spectrograms -->
    <div class="card lg:col-span-1">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" />
                </svg>
                Recent Spectrograms
            </h2>
            <span class="text-xs text-gray-500">Last 10</span>
        </div>
        <div id="spectrograms-list" class="space-y-2 max-h-[400px] overflow-y-auto custom-scroll">
            <div class="flex items-center justify-center py-8 text-gray-500">
                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                Loading...
            </div>
        </div>
    </div>

    <!-- AI Analysis Panel -->
    <div class="card lg:col-span-2">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                AI Analysis Results
            </h2>
            <span id="ai-provider-badge" class="text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400">GPT-4o
                Vision</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Spectrogram Image -->
            <div id="spectrogram-preview" class="spectrogram-preview">
                <div class="text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-sm">Select a spectrogram to view</p>
                </div>
                <img id="spec-image" src="" alt="Spectrogram" class="hidden w-full rounded-lg border border-gray-700">
            </div>

            <!-- Analysis Details -->
            <div id="latest-analysis">
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <p class="text-sm">No analysis selected</p>
                    <p class="text-xs mt-1 text-gray-600">Click a spectrogram to see AI analysis</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Status Row -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- LoRa Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                </svg>
                LoRa Radio Status
            </h2>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Status</span>
                <span id="lora-running" class="status-badge online">
                    <span class="status-dot"></span>
                    Checking...
                </span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Packets Received</span>
                <span id="lora-packets" class="font-mono text-white">-</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Spectrograms</span>
                <span id="lora-specs" class="font-mono text-purple-400">-</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Last RSSI</span>
                <span id="lora-rssi" class="font-mono text-cyan-400">- dBm</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-gray-400 text-sm">Last SNR</span>
                <span id="lora-snr" class="font-mono text-cyan-400">- dB</span>
            </div>
        </div>
    </div>

    <!-- AI Mode Control -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                AI Analysis Mode
            </h2>
        </div>
        <div class="space-y-3">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-400 text-sm">Current Mode</span>
                <span id="current-ai-mode" class="font-bold text-emerald-400">-</span>
            </div>
            <select id="ai-mode-select" class="w-full">
                <option value="gpt4o">‚óè GPT-4o Vision (Detailed)</option>
                <option value="custom_vision">‚óè Custom Vision (Fast)</option>
                <option value="auto">‚óè Auto (CV + GPT-4o verify)</option>
            </select>
            <button id="apply-ai-mode" class="btn btn-primary w-full">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Apply Changes
            </button>
            <p id="ai-mode-desc" class="text-xs text-gray-500">Detailed analysis with visual reasoning</p>
        </div>
    </div>

    <!-- AI Service Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Service Status
            </h2>
        </div>
        <div class="space-y-3">
            <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm text-white">Azure GPT-4o</span>
                </div>
                <span id="gpt4o-status" class="status-badge pending">
                    <span class="status-dot"></span>
                    Checking
                </span>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-sm text-white">Custom Vision</span>
                </div>
                <span id="cv-status" class="status-badge pending">
                    <span class="status-dot"></span>
                    Checking
                </span>
            </div>
            <div class="flex justify-between items-center p-3 bg-gray-800/50 rounded-lg">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                    </svg>
                    <span class="text-sm text-white">LoRa Receiver</span>
                </div>
                <span id="lora-service-status" class="status-badge online">
                    <span class="status-dot"></span>
                    Active
                </span>
            </div>
        </div>
    </div>
</div>

<script>
    // Global state
    let selectedSpectrogramId = null;
    let currentViewMode = 'current';
    let currentDate = new Date().toISOString().split('T')[0];
    let currentMonth = new Date().toISOString().slice(0, 7);
    let currentYear = new Date().getFullYear().toString();

    // Initialize date pickers with current values
    document.getElementById('date-picker').value = currentDate;
    document.getElementById('month-picker').value = currentMonth;
    document.getElementById('year-picker').value = currentYear;

    // Time tab click handler
    document.querySelectorAll('.time-tab').forEach(btn => {
        btn.addEventListener('click', function () {
            const view = this.dataset.view;
            currentViewMode = view;
            document.getElementById('view-mode').value = view;

            // Update active state
            document.querySelectorAll('.time-tab').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            updateDatePickerVisibility();
            updatePeriodDisplay();
            loadFilteredStats();
        });
    });

    // View mode change handler (hidden select for compatibility)
    document.getElementById('view-mode').addEventListener('change', function () {
        currentViewMode = this.value;
        updateDatePickerVisibility();
        updatePeriodDisplay();
        loadFilteredStats();
    });

    // Date picker change handlers
    document.getElementById('date-picker').addEventListener('change', function () {
        currentDate = this.value;
        updatePeriodDisplay();
        loadFilteredStats();
    });

    document.getElementById('month-picker').addEventListener('change', function () {
        currentMonth = this.value;
        updatePeriodDisplay();
        loadFilteredStats();
    });

    document.getElementById('year-picker').addEventListener('change', function () {
        currentYear = this.value;
        updatePeriodDisplay();
        loadFilteredStats();
    });

    function updateDatePickerVisibility() {
        const datePicker = document.getElementById('date-picker');
        const monthPicker = document.getElementById('month-picker');
        const yearPicker = document.getElementById('year-picker');

        // Hide all pickers first
        datePicker.classList.add('hidden');
        monthPicker.classList.add('hidden');
        yearPicker.classList.add('hidden');

        if (currentViewMode === 'day') {
            datePicker.classList.remove('hidden');
        } else if (currentViewMode === 'month') {
            monthPicker.classList.remove('hidden');
        } else if (currentViewMode === 'year') {
            yearPicker.classList.remove('hidden');
        }
    }

    function updatePeriodDisplay() {
        const display = document.getElementById('period-display');
        const alertLabel = document.getElementById('alert-label');
        const specLabel = document.getElementById('spec-label');
        const chainsawLabel = document.getElementById('chainsaw-label');

        if (currentViewMode === 'current') {
            display.textContent = 'Today';
            alertLabel.textContent = 'Alerts Today';
            specLabel.textContent = 'Spectrograms Today';
            chainsawLabel.textContent = 'Chainsaws Today';
        } else if (currentViewMode === 'day') {
            const date = new Date(currentDate);
            display.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            alertLabel.textContent = 'Alerts';
            specLabel.textContent = 'Spectrograms';
            chainsawLabel.textContent = 'Chainsaws';
        } else if (currentViewMode === 'month') {
            const [year, month] = currentMonth.split('-');
            const date = new Date(year, month - 1);
            display.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            alertLabel.textContent = 'Alerts';
            specLabel.textContent = 'Spectrograms';
            chainsawLabel.textContent = 'Chainsaws';
        } else if (currentViewMode === 'year') {
            display.textContent = currentYear;
            alertLabel.textContent = 'Alerts';
            specLabel.textContent = 'Spectrograms';
            chainsawLabel.textContent = 'Chainsaws';
        }
    }

    // Load stats based on current filter with retry logic
    function loadFilteredStats() {
        // Always load live node count
        fetch('/api/nodes')
            .then(r => {
                if (!r.ok) throw new Error('Network error');
                return r.json();
            })
            .then(data => {
                const onlineCount = data.filter(n => n.is_online).length;
                const totalCount = data.length;
                document.getElementById('node-count').textContent = onlineCount;
                // Update title with total if there are offline nodes
                const nodeCard = document.querySelector('.stat-card.nodes');
                if (nodeCard && totalCount > onlineCount) {
                    nodeCard.title = `${onlineCount} online, ${totalCount - onlineCount} offline`;
                }
            })
            .catch(err => {
                console.warn('Failed to load nodes:', err);
                // Don't reset to 0 on network error - keep last value
            });

        // Build query params based on filter
        let params = new URLSearchParams();
        if (currentViewMode === 'day') {
            params.set('date', currentDate);
        } else if (currentViewMode === 'month') {
            params.set('month', currentMonth);
        } else if (currentViewMode === 'year') {
            params.set('year', currentYear);
        }
        // current mode = no params (today's data)

        const queryString = params.toString() ? '?' + params.toString() : '';

        fetch('/api/dashboard/stats' + queryString)
            .then(r => {
                if (!r.ok) throw new Error('Network error');
                return r.json();
            })
            .then(data => {
                document.getElementById('alert-count').textContent = data.alerts || 0;
                document.getElementById('spec-count').textContent = data.spectrograms || 0;
                document.getElementById('chainsaw-count').textContent = data.chainsaws || 0;
            })
            .catch(err => {
                console.warn('Failed to load stats:', err);
                // Don't reset on network error - keep last values
            });

        // Load LoRa status (always live)
        loadLoraStatus();
    }

    function loadLoraStatus() {
        fetch('/api/lora/status')
            .then(r => r.json())
            .then(data => {
                const badge = document.getElementById('lora-running');
                const serviceBadge = document.getElementById('lora-service-status');

                if (data.status === 'running') {
                    badge.innerHTML = '<span class="status-dot"></span>Online';
                    badge.className = 'status-badge online';
                    if (serviceBadge) {
                        serviceBadge.innerHTML = '<span class="status-dot"></span>Active';
                        serviceBadge.className = 'status-badge online';
                    }

                    // Show health warning if needed
                    if (data.health === 'warning' && serviceBadge) {
                        serviceBadge.innerHTML = '<span class="status-dot"></span>Warning';
                        serviceBadge.className = 'status-badge';
                        serviceBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                        serviceBadge.style.color = '#f59e0b';
                    } else if (data.health === 'critical' && serviceBadge) {
                        serviceBadge.innerHTML = '<span class="status-dot"></span>No Data';
                        serviceBadge.className = 'status-badge offline';
                    }
                } else {
                    badge.innerHTML = '<span class="status-dot"></span>Offline';
                    badge.className = 'status-badge offline';
                    if (serviceBadge) {
                        serviceBadge.innerHTML = '<span class="status-dot"></span>Offline';
                        serviceBadge.className = 'status-badge offline';
                    }
                }

                // Update LoRa stats
                if (data.stats) {
                    const stats = data.stats;
                    document.getElementById('lora-packets').textContent = stats.packets_received || 0;
                    document.getElementById('lora-specs').textContent = stats.spectrograms_saved || 0;

                    if (stats.last_rssi !== undefined && stats.last_rssi !== null) {
                        document.getElementById('lora-rssi').textContent = stats.last_rssi + ' dBm';
                    }
                    if (stats.last_snr !== undefined && stats.last_snr !== null) {
                        document.getElementById('lora-snr').textContent = stats.last_snr + ' dB';
                    }
                }
            })
            .catch(() => { });
    }

    // Legacy loadStats for compatibility
    function loadStats() {
        loadFilteredStats();
    }

    // Update last update time
    function updateLastUpdateTime() {
        document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
    }

    // Load recent spectrograms with date filtering
    function loadSpectrograms() {
        // Build query params based on filter
        let params = new URLSearchParams();
        if (currentViewMode === 'day') {
            params.set('date', currentDate);
        } else if (currentViewMode === 'month') {
            params.set('month', currentMonth);
        } else if (currentViewMode === 'year') {
            params.set('year', currentYear);
        }
        // current mode = no params (today's data)
        const queryString = params.toString() ? '?' + params.toString() : '';

        fetch('/api/spectrograms' + queryString).then(r => r.json()).then(data => {
            const list = document.getElementById('spectrograms-list');
            if (!data || data.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-gray-500"><svg class="w-10 h-10 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/></svg><p class="text-sm">No spectrograms yet</p><p class="text-xs mt-1">Waiting for node data...</p></div>';
                return;
            }
            list.innerHTML = data.slice(0, 10).map(s => '<div class="list-item ' + (selectedSpectrogramId === s.id ? 'ring-2 ring-emerald-500' : '') + '" onclick="showSpectrogram(' + s.id + ')"><div class="flex-1 min-w-0"><div class="flex items-center gap-2"><span class="list-item-title">' + s.node_id + '</span>' + getThreatBadge(s.threat_level) + '</div><div class="list-item-subtitle truncate">' + (s.classification || 'Analyzing...') + ' ' + (s.confidence ? '(' + s.confidence + '%)' : '') + '</div><div class="list-item-meta">' + formatTime(s.timestamp) + '</div></div><svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>').join('');
        }).catch(() => {
            document.getElementById('spectrograms-list').innerHTML = '<div class="text-center py-8 text-gray-500"><p class="text-sm">No spectrograms yet</p></div>';
        });
    }

    function getThreatBadge(level) {
        const badges = {
            'CRITICAL': '<span class="status-badge" style="background:rgba(239,68,68,0.2);color:#ef4444">CRITICAL</span>',
            'HIGH': '<span class="status-badge" style="background:rgba(249,115,22,0.2);color:#f97316">HIGH</span>',
            'MEDIUM': '<span class="status-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b">MEDIUM</span>',
            'LOW': '<span class="status-badge" style="background:rgba(16,185,129,0.2);color:#10b981">LOW</span>'
        };
        return badges[level] || '<span class="status-badge pending"><span class="status-dot"></span>Pending</span>';
    }

    function formatTime(timestamp) {
        const date = new Date(timestamp);
        const now = new Date();
        const diff = (now - date) / 1000;
        if (diff < 60) return 'Just now';
        if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
        if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
        return date.toLocaleDateString();
    }

    function showSpectrogram(id) {
        selectedSpectrogramId = id;
        loadSpectrograms();

        fetch('/api/spectrograms/' + id).then(r => r.json()).then(s => {
            const preview = document.getElementById('spectrogram-preview');
            const img = document.getElementById('spec-image');
            const analysis = document.getElementById('latest-analysis');

            if (s.image_path) {
                img.src = '/api/spectrograms/image/' + s.image_path.split('/').pop();
                img.classList.remove('hidden');
                const placeholder = preview.querySelector('div');
                if (placeholder) placeholder.classList.add('hidden');
            }

            const providerBadge = document.getElementById('ai-provider-badge');
            // Check both service_used and ai_provider fields
            const service = s.service_used || s.ai_provider;
            if (service === 'gpt4o') {
                providerBadge.textContent = 'GPT-4o Vision';
                providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400';
            } else if (service === 'custom_vision') {
                providerBadge.textContent = 'Custom Vision';
                providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-400';
            } else {
                // Show current mode for pending analysis
                fetch('/api/ai/mode').then(r => r.json()).then(data => {
                    if (data.mode === 'custom_vision') {
                        providerBadge.textContent = 'Custom Vision';
                        providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-400';
                    } else {
                        providerBadge.textContent = 'GPT-4o Vision';
                        providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400';
                    }
                });
            }

            const isChainsaw = s.classification === 'chainsaw';
            const isPending = !s.classification || s.classification === 'unknown' || s.confidence === 0;
            const iconSvg = isChainsaw
                ? '<svg class="w-8 h-8 text-red-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>'
                : '<svg class="w-8 h-8 text-emerald-400 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z"/></svg>';
            const retryButton = isPending ? '<button onclick="retryAnalysis(' + s.id + ')" class="w-full mt-3 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-medium transition-colors"><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis</button>' : '';
            analysis.innerHTML = '<div class="space-y-4"><div class="text-center p-4 rounded-lg ' + (isChainsaw ? 'bg-red-500/10 border border-red-500/30' : 'bg-emerald-500/10 border border-emerald-500/30') + '"><div class="mb-2">' + iconSvg + '</div><div class="text-lg font-bold ' + (isChainsaw ? 'text-red-400' : 'text-emerald-400') + '">' + (s.classification || 'Unknown').toUpperCase() + '</div><div class="text-3xl font-bold text-white mt-1">' + (s.confidence || 0) + '%</div>' + getThreatBadge(s.threat_level) + retryButton + '</div><div class="p-3 bg-gray-800/50 rounded-lg"><div class="text-xs text-gray-500 mb-1 font-medium">AI Analysis</div><p class="text-sm text-gray-300 leading-relaxed">' + (s.ai_reasoning || 'Analysis pending...') + '</p></div><div class="grid grid-cols-2 gap-2 text-xs"><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Node</div><div class="font-mono text-white">' + s.node_id + '</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Location</div><div class="font-mono text-white">' + (s.lat ? s.lat.toFixed(4) : '-') + ', ' + (s.lon ? s.lon.toFixed(4) : '-') + '</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">RSSI</div><div class="font-mono text-cyan-400">' + (s.rssi || '-') + ' dBm</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Time</div><div class="font-mono text-white">' + new Date(s.timestamp).toLocaleString() + '</div></div></div></div>';
        }).catch(err => console.error('Error loading spectrogram:', err));
    }

    function loadAiMode() {
        fetch('/api/ai/mode').then(r => r.json()).then(data => {
            document.getElementById('current-ai-mode').textContent = data.mode.toUpperCase();
            document.getElementById('ai-mode-select').value = data.mode;
            updateAiModeDesc(data.mode);
        }).catch(() => { });

        fetch('/api/ai/status').then(r => r.json()).then(data => {
            const gpt4oStatus = document.getElementById('gpt4o-status');
            const cvStatus = document.getElementById('cv-status');
            if (data.services.gpt4o.configured) {
                gpt4oStatus.innerHTML = '<span class="status-dot"></span>Ready';
                gpt4oStatus.className = 'status-badge online';
            } else {
                gpt4oStatus.innerHTML = '<span class="status-dot"></span>Not Configured';
                gpt4oStatus.className = 'status-badge offline';
            }
            if (data.services.custom_vision.configured) {
                cvStatus.innerHTML = '<span class="status-dot"></span>Ready';
                cvStatus.className = 'status-badge online';
            } else {
                cvStatus.innerHTML = '<span class="status-dot"></span>Not Configured';
                cvStatus.className = 'status-badge offline';
            }
        }).catch(() => { });
    }

    function updateAiModeDesc(mode) {
        const desc = {
            'gpt4o': 'Detailed analysis with visual reasoning and recommendations',
            'custom_vision': 'Fast classification with your trained model',
            'auto': 'Uses Custom Vision first, verifies threats with GPT-4o'
        };
        document.getElementById('ai-mode-desc').textContent = desc[mode] || 'Select AI service';
    }

    document.getElementById('ai-mode-select').addEventListener('change', function () {
        updateAiModeDesc(this.value);
    });

    document.getElementById('apply-ai-mode').addEventListener('click', function () {
        const btn = this;
        const mode = document.getElementById('ai-mode-select').value;
        btn.disabled = true;
        btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Applying...';

        fetch('/api/ai/mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        }).then(r => {
            if (!r.ok) {
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            const contentType = r.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('Server returned non-JSON response. Session may have expired.');
            }
            return r.json();
        }).then(data => {
            btn.disabled = false;
            if (data.success) {
                btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Applied!';
                document.getElementById('current-ai-mode').textContent = data.mode.toUpperCase();
                setTimeout(() => {
                    btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Apply Changes';
                }, 2000);
            } else {
                btn.innerHTML = '‚ùå Error';
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        }).catch(err => {
            btn.disabled = false;
            btn.innerHTML = '‚ùå Error';
            console.error('AI mode error:', err);
            alert('Error: ' + err.message);
        });
    });

    loadStats();
    loadSpectrograms();
    loadAiMode();
    loadLoraStatus();
    updatePeriodDisplay();

    // Fast polling for responsive dashboard
    // Socket.IO events also trigger immediate updates
    setInterval(() => { loadStats(); loadLoraStatus(); updateLastUpdateTime(); }, 3000);
    setInterval(loadSpectrograms, 5000);

    // Socket.IO events (socket declared in app.js)
    socket.on('connect', () => {
        const badge = document.getElementById('connection-status');
        badge.innerHTML = '<span class="status-dot"></span>Live';
        badge.className = 'status-badge online';
    });
    socket.on('disconnect', () => {
        const badge = document.getElementById('connection-status');
        badge.innerHTML = '<span class="status-dot"></span>Offline';
        badge.className = 'status-badge offline';
    });
    socket.on('new_spectrogram', (data) => {
        console.log('üì° New spectrogram received:', data);
        loadSpectrograms();
        loadStats();
        loadLoraStatus();
    });
    socket.on('spectrogram_analyzed', (data) => {
        console.log('üîç Spectrogram analyzed:', data);
        loadSpectrograms();
        loadStats();
        loadLoraStatus();
        if (selectedSpectrogramId === data.spectrogram_id) showSpectrogram(data.spectrogram_id);
        if (data.classification === 'chainsaw' && data.confidence >= 70) {
            alert('‚ö†Ô∏è CHAINSAW DETECTED!\n\nNode: ' + data.node_id + '\nConfidence: ' + data.confidence + '%');
        }
    });
    socket.on('new_alert', (data) => loadStats());
    socket.on('node_update', (data) => loadStats());
    socket.on('ai_mode_changed', (data) => {
        document.getElementById('current-ai-mode').textContent = data.mode.toUpperCase();
        document.getElementById('ai-mode-select').value = data.mode;
        updateAiModeDesc(data.mode);
    });

    // Retry analysis for pending spectrograms
    function retryAnalysis(specId) {
        const btn = event.target;
        btn.disabled = true;
        btn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Analyzing...';

        fetch('/api/spectrograms/' + specId + '/analyze', { method: 'POST' })
            .then(r => {
                if (!r.ok) {
                    return r.json().then(data => { throw new Error(data.error || 'Analysis failed'); });
                }
                return r.json();
            })
            .then(data => {
                if (data.success) {
                    showSpectrogram(specId);
                    loadSpectrograms();
                    loadStats();
                } else {
                    alert('Analysis failed: ' + (data.error || 'Unknown error'));
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis';
                }
            })
            .catch(err => {
                alert('Error: ' + err.message);
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis';
            });
    }
</script>
{% endblock %}