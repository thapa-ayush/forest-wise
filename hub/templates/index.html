{% extends 'base.html' %}
{% block content %}
<!-- Top Bar -->
<div class="dashboard-topbar">
    <!-- Time Filter - Simple Tab Style -->
    <div class="time-tabs-container">
        <button class="time-tab active" data-view="current">
            <span class="live-dot"></span>
            <span class="tab-text">Live</span>
        </button>
        <button class="time-tab" data-view="day">
            <span class="tab-text">Day</span>
        </button>
        <button class="time-tab" data-view="month">
            <span class="tab-text">Month</span>
        </button>
        <button class="time-tab" data-view="year">
            <span class="tab-text">Year</span>
        </button>
    </div>

    <!-- Period & Date Picker -->
    <div class="date-picker-container">
        <span id="period-display" class="period-text">Today</span>
        <input type="date" id="date-picker" class="date-input hidden">
        <input type="month" id="month-picker" class="date-input hidden">
        <select id="year-picker" class="date-input hidden">
            <option value="2026">2026</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
        </select>
    </div>

    <!-- Status -->
    <div class="status-container">
        <span id="connection-status" class="status-badge online">
            <span class="status-dot"></span>
            <span class="status-text">Live</span>
        </span>
        <span class="update-text" id="last-update">Updated just now</span>
    </div>
</div>

<!-- Hidden select for compatibility -->
<select id="view-mode" class="hidden">
    <option value="current">Current (Live)</option>
    <option value="day">Day</option>
    <option value="month">Month</option>
    <option value="year">Year</option>
</select>

<style>
    /* Dashboard Top Bar - Responsive */
    .dashboard-topbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .time-tabs-container {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        background: rgba(31, 41, 55, 0.5);
        border-radius: 0.5rem;
        padding: 0.25rem;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        flex-shrink: 0;
    }

    .time-tabs-container::-webkit-scrollbar {
        display: none;
    }

    .time-tab {
        padding: 0.5rem 0.875rem;
        border-radius: 0.375rem;
        font-size: 0.8125rem;
        color: #9ca3af;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        white-space: nowrap;
        border: none;
        background: transparent;
        cursor: pointer;
        min-height: 36px;
    }

    .time-tab:hover {
        color: #fff;
        background: rgba(55, 65, 81, 0.5);
    }

    .time-tab.active {
        color: #10b981;
        background: rgba(16, 185, 129, 0.15);
    }

    .live-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        animation: pulse 2s infinite;
    }

    .date-picker-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .period-text {
        font-size: 0.8125rem;
        color: #9ca3af;
    }

    .date-input {
        background: rgba(31, 41, 55, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 0.5rem;
        padding: 0.375rem 0.625rem;
        font-size: 0.8125rem;
        color: white;
        min-height: 36px;
    }

    .status-container {
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .update-text {
        font-size: 0.75rem;
        color: #6b7280;
    }

    /* Small screen adjustments */
    @media screen and (max-width: 800px) {
        .dashboard-topbar {
            justify-content: flex-start;
            margin-bottom: 0.75rem;
        }

        .time-tab {
            padding: 0.375rem 0.625rem;
            font-size: 0.75rem;
            min-height: 32px;
        }

        .live-dot {
            width: 6px;
            height: 6px;
        }

        .date-picker-container {
            display: none;
        }

        .status-container {
            margin-left: auto;
        }

        .update-text {
            display: none;
        }

        .status-text {
            display: none;
        }
    }

    @media screen and (max-width: 480px) {
        .time-tabs-container {
            max-width: 200px;
        }

        .tab-text {
            font-size: 0.6875rem;
        }
    }
</style>

<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card nodes">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-label">Active Nodes</div>
            <div class="stat-value" id="node-count">-</div>
        </div>
    </div>

    <div class="stat-card alerts">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-label" id="alert-label">Alerts</div>
            <div class="stat-value" id="alert-count">-</div>
        </div>
    </div>

    <div class="stat-card spectrograms">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-label" id="spec-label">Spectrograms</div>
            <div class="stat-value" id="spec-count">-</div>
        </div>
    </div>

    <div class="stat-card detections">
        <div class="stat-icon">
            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
        </div>
        <div class="stat-content">
            <div class="stat-label" id="chainsaw-label">Chainsaws</div>
            <div class="stat-value" id="chainsaw-count">-</div>
        </div>
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .stat-card .stat-content {
        display: flex;
        flex-direction: column;
    }

    @media screen and (max-width: 1024px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }
    }

    @media screen and (max-width: 800px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .stat-card {
            padding: 0.75rem;
        }

        .stat-icon {
            width: 32px;
            height: 32px;
            margin-bottom: 0.375rem;
        }

        .stat-icon svg {
            width: 16px;
            height: 16px;
        }

        .stat-label {
            font-size: 0.625rem !important;
        }

        .stat-value {
            font-size: 1.125rem !important;
        }
    }

    @media screen and (max-width: 480px) {
        .stats-grid {
            gap: 0.375rem;
        }

        .stat-card {
            padding: 0.625rem;
        }

        .stat-icon {
            width: 28px;
            height: 28px;
        }

        .stat-value {
            font-size: 1rem !important;
        }
    }

    /* Landscape mode for 5" display */
    @media screen and (max-width: 800px) and (max-height: 480px) and (orientation: landscape) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.375rem;
            margin-bottom: 0.5rem;
        }

        .stat-card {
            padding: 0.5rem;
        }

        .stat-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
        }

        .stat-icon svg {
            width: 12px;
            height: 12px;
        }

        .stat-label {
            font-size: 0.5625rem !important;
        }

        .stat-value {
            font-size: 0.875rem !important;
        }
    }
</style>

<!-- Main Content Grid -->
<div class="content-grid">
    <!-- Recent Spectrograms -->
    <div class="card spectrograms-card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z" />
                </svg>
                <span>Spectrograms</span>
            </h2>
            <span class="card-subtitle">Last 10</span>
        </div>
        <div id="spectrograms-list" class="scrollable-list custom-scroll">
            <div class="loading-placeholder">
                <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                </svg>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <!-- AI Analysis Panel -->
    <div class="card ai-card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                <span>AI Analysis</span>
            </h2>
            <span id="ai-provider-badge" class="text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400">GPT-4o
                Vision</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Spectrogram Image -->
            <div id="spectrogram-preview" class="spectrogram-preview">
                <div class="text-gray-500 py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="text-sm">Select a spectrogram to view</p>
                </div>
                <img id="spec-image" src="" alt="Spectrogram" class="hidden w-full rounded-lg border border-gray-700">
            </div>

            <!-- Analysis Details -->
            <div id="latest-analysis">
                <div class="text-center py-8 text-gray-500">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                    </svg>
                    <p class="text-sm">No analysis selected</p>
                    <p class="text-xs mt-1 text-gray-600">Click a spectrogram to see AI analysis</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Content Grid Responsive */
    .content-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: stretch;
    }

    .spectrograms-card {
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .spectrograms-card .card-header {
        flex-shrink: 0;
    }

    .ai-card {
        min-width: 0;
        display: flex;
        flex-direction: column;
    }

    .ai-card .card-header {
        flex-shrink: 0;
    }

    .ai-card>.grid {
        flex: 1;
    }

    .scrollable-list {
        flex: 1;
        min-height: 180px;
        max-height: 400px;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch;
        padding-right: 0.25rem;
    }

    /* Custom scrollbar for spectrograms list */
    .scrollable-list::-webkit-scrollbar {
        width: 6px;
    }

    .scrollable-list::-webkit-scrollbar-track {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 3px;
    }

    .scrollable-list::-webkit-scrollbar-thumb {
        background: rgba(107, 114, 128, 0.5);
        border-radius: 3px;
    }

    .scrollable-list::-webkit-scrollbar-thumb:hover {
        background: rgba(107, 114, 128, 0.8);
    }

    .loading-placeholder {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 2rem;
        color: #6b7280;
        min-height: 180px;
    }

    .card-subtitle {
        font-size: 0.75rem;
        color: #6b7280;
    }

    @media screen and (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media screen and (max-width: 800px) {
        .content-grid {
            grid-template-columns: 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
            align-items: start;
        }

        .scrollable-list {
            max-height: 180px;
            min-height: 120px;
        }

        .spectrogram-preview,
        #latest-analysis {
            min-height: auto;
        }

        .ai-card .grid {
            grid-template-columns: 1fr !important;
            gap: 0.75rem !important;
        }
    }

    @media screen and (max-width: 480px) {
        .scrollable-list {
            max-height: 150px;
        }
    }

    /* Landscape mode for 5" display */
    @media screen and (max-width: 800px) and (max-height: 480px) and (orientation: landscape) {
        .content-grid {
            grid-template-columns: 1fr 2fr;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .scrollable-list {
            max-height: 150px;
        }

        .card {
            padding: 0.625rem;
        }

        .card-header {
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .card-title {
            font-size: 0.75rem;
        }

        .card-title svg {
            width: 14px;
            height: 14px;
        }
    }

    /* System status row responsive */
    .system-status-row {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        align-items: stretch;
    }

    .system-status-row>.card {
        display: flex;
        flex-direction: column;
    }

    .system-status-row>.card>.card-header {
        flex-shrink: 0;
    }

    .system-status-row>.card:hover {
        transform: none;
    }

    @media screen and (max-width: 800px) {
        .system-status-row {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }
    }

    @media screen and (max-width: 800px) and (max-height: 480px) and (orientation: landscape) {
        .system-status-row {
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }
    }
</style>

<!-- System Status Row -->
<div class="system-status-row">
    <!-- LoRa Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                </svg>
                LoRa Radio
            </h2>
            <span id="lora-running" class="status-badge online">
                <span class="status-dot"></span>
                Checking...
            </span>
        </div>
        <div class="flex-1 flex flex-col">
            <div class="grid grid-cols-2 gap-2 mb-3">
                <div class="p-2.5 bg-gray-800/40 rounded-lg text-center">
                    <div class="text-xl font-bold text-white" id="lora-packets">-</div>
                    <div class="text-xs text-gray-500">Packets</div>
                </div>
                <div class="p-2.5 bg-gray-800/40 rounded-lg text-center">
                    <div class="text-xl font-bold text-purple-400" id="lora-specs">-</div>
                    <div class="text-xs text-gray-500">Spectrograms</div>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-2">
                <div class="p-2 bg-gray-800/40 rounded-lg text-center">
                    <div class="text-sm font-mono text-cyan-400" id="lora-rssi">- dBm</div>
                    <div class="text-xs text-gray-500">RSSI</div>
                </div>
                <div class="p-2 bg-gray-800/40 rounded-lg text-center">
                    <div class="text-sm font-mono text-cyan-400" id="lora-snr">- dB</div>
                    <div class="text-xs text-gray-500">SNR</div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Mode Control -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
                AI Mode
            </h2>
            <span id="current-ai-mode" class="text-sm font-bold text-emerald-400">-</span>
        </div>
        <div class="flex-1 flex flex-col">
            <div class="grid grid-cols-2 gap-2 mb-2">
                <button onclick="setAiMode('gpt4o')" class="ai-mode-btn" data-mode="gpt4o">
                    <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    <span class="text-xs">GPT-4o</span>
                </button>
                <button onclick="setAiMode('custom_vision')" class="ai-mode-btn" data-mode="custom_vision">
                    <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-xs">Custom Vision</span>
                </button>
                <button onclick="setAiMode('auto')" class="ai-mode-btn" data-mode="auto">
                    <svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span class="text-xs">Auto</span>
                </button>
                <button onclick="setAiMode('local')" class="ai-mode-btn" data-mode="local">
                    <svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    <span class="text-xs">Local</span>
                </button>
            </div>
            <p id="ai-mode-desc" class="text-xs text-gray-500 text-center py-1.5 px-2 bg-gray-800/30 rounded mt-auto">
                Detailed
                analysis with visual reasoning</p>
        </div>
    </div>

    <!-- AI Service Status -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">
                <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Services
            </h2>
        </div>
        <div class="flex-1 flex flex-col">
            <div class="space-y-1.5 flex-1">
                <div class="flex justify-between items-center p-2 bg-gray-800/40 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-md bg-cyan-500/20 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-cyan-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        <span class="text-sm text-white">GPT-4o</span>
                    </div>
                    <span id="gpt4o-status" class="status-badge pending text-xs">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking</span>
                    </span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-800/40 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-md bg-amber-500/20 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-amber-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <span class="text-sm text-white">Custom Vision</span>
                    </div>
                    <span id="cv-status" class="status-badge pending text-xs">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking</span>
                    </span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-800/40 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-md bg-green-500/20 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-green-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                            </svg>
                        </div>
                        <span class="text-sm text-white">Local TFLite</span>
                    </div>
                    <span id="local-status" class="status-badge pending text-xs">
                        <span class="status-dot"></span>
                        <span class="status-text">Checking</span>
                    </span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-800/40 rounded-lg">
                    <div class="flex items-center gap-2">
                        <div class="w-7 h-7 rounded-md bg-purple-500/20 flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-purple-400" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                            </svg>
                        </div>
                        <span class="text-sm text-white">LoRa Radio</span>
                    </div>
                    <span id="lora-service-status" class="status-badge online text-xs">
                        <span class="status-dot"></span>
                        <span class="status-text">Active</span>
                    </span>
                </div>
            </div>
            <!-- Compact Sync Section -->
            <div class="mt-2 pt-2 border-t border-gray-700/50 flex items-center justify-between">
                <div class="flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    <span class="text-xs text-gray-400">Sync:</span>
                    <span id="sync-pending-count" class="text-xs text-blue-400 font-bold">0</span>
                    <span class="text-xs text-gray-500">pending</span>
                </div>
                <button id="manual-sync-btn" class="btn btn-secondary text-xs py-1 px-2" onclick="triggerManualSync()">
                    Sync Now
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let selectedSpectrogramId = null;
        let currentViewMode = 'current';
        let currentDate = new Date().toISOString().split('T')[0];
        let currentMonth = new Date().toISOString().slice(0, 7);
        let currentYear = new Date().getFullYear().toString();

        // Initialize date pickers with current values
        document.getElementById('date-picker').value = currentDate;
        document.getElementById('month-picker').value = currentMonth;
        document.getElementById('year-picker').value = currentYear;

        // Time tab click handler
        document.querySelectorAll('.time-tab').forEach(btn => {
            btn.addEventListener('click', function () {
                const view = this.dataset.view;
                currentViewMode = view;
                document.getElementById('view-mode').value = view;

                // Update active state
                document.querySelectorAll('.time-tab').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                updateDatePickerVisibility();
                updatePeriodDisplay();
                loadFilteredStats();
            });
        });

        // View mode change handler (hidden select for compatibility)
        document.getElementById('view-mode').addEventListener('change', function () {
            currentViewMode = this.value;
            updateDatePickerVisibility();
            updatePeriodDisplay();
            loadFilteredStats();
        });

        // Date picker change handlers
        document.getElementById('date-picker').addEventListener('change', function () {
            currentDate = this.value;
            updatePeriodDisplay();
            loadFilteredStats();
        });

        document.getElementById('month-picker').addEventListener('change', function () {
            currentMonth = this.value;
            updatePeriodDisplay();
            loadFilteredStats();
        });

        document.getElementById('year-picker').addEventListener('change', function () {
            currentYear = this.value;
            updatePeriodDisplay();
            loadFilteredStats();
        });

        function updateDatePickerVisibility() {
            const datePicker = document.getElementById('date-picker');
            const monthPicker = document.getElementById('month-picker');
            const yearPicker = document.getElementById('year-picker');

            // Hide all pickers first
            datePicker.classList.add('hidden');
            monthPicker.classList.add('hidden');
            yearPicker.classList.add('hidden');

            if (currentViewMode === 'day') {
                datePicker.classList.remove('hidden');
            } else if (currentViewMode === 'month') {
                monthPicker.classList.remove('hidden');
            } else if (currentViewMode === 'year') {
                yearPicker.classList.remove('hidden');
            }
        }

        function updatePeriodDisplay() {
            const display = document.getElementById('period-display');
            const alertLabel = document.getElementById('alert-label');
            const specLabel = document.getElementById('spec-label');
            const chainsawLabel = document.getElementById('chainsaw-label');

            if (currentViewMode === 'current') {
                display.textContent = 'Today';
                alertLabel.textContent = 'Alerts Today';
                specLabel.textContent = 'Spectrograms Today';
                chainsawLabel.textContent = 'Chainsaws Today';
            } else if (currentViewMode === 'day') {
                const date = new Date(currentDate);
                display.textContent = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                alertLabel.textContent = 'Alerts';
                specLabel.textContent = 'Spectrograms';
                chainsawLabel.textContent = 'Chainsaws';
            } else if (currentViewMode === 'month') {
                const [year, month] = currentMonth.split('-');
                const date = new Date(year, month - 1);
                display.textContent = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                alertLabel.textContent = 'Alerts';
                specLabel.textContent = 'Spectrograms';
                chainsawLabel.textContent = 'Chainsaws';
            } else if (currentViewMode === 'year') {
                display.textContent = currentYear;
                alertLabel.textContent = 'Alerts';
                specLabel.textContent = 'Spectrograms';
                chainsawLabel.textContent = 'Chainsaws';
            }
        }

        // Load stats based on current filter with retry logic
        function loadFilteredStats() {
            // Always load live node count
            fetch('/api/nodes')
                .then(r => {
                    if (!r.ok) throw new Error('Network error');
                    return r.json();
                })
                .then(data => {
                    const onlineCount = data.filter(n => n.is_online).length;
                    const totalCount = data.length;
                    document.getElementById('node-count').textContent = onlineCount;
                    // Update title with total if there are offline nodes
                    const nodeCard = document.querySelector('.stat-card.nodes');
                    if (nodeCard && totalCount > onlineCount) {
                        nodeCard.title = `${onlineCount} online, ${totalCount - onlineCount} offline`;
                    }
                })
                .catch(err => {
                    console.warn('Failed to load nodes:', err);
                    // Don't reset to 0 on network error - keep last value
                });

            // Build query params based on filter
            let params = new URLSearchParams();
            if (currentViewMode === 'day') {
                params.set('date', currentDate);
            } else if (currentViewMode === 'month') {
                params.set('month', currentMonth);
            } else if (currentViewMode === 'year') {
                params.set('year', currentYear);
            }
            // current mode = no params (today's data)

            const queryString = params.toString() ? '?' + params.toString() : '';

            fetch('/api/dashboard/stats' + queryString)
                .then(r => {
                    if (!r.ok) throw new Error('Network error');
                    return r.json();
                })
                .then(data => {
                    document.getElementById('alert-count').textContent = data.alerts || 0;
                    document.getElementById('spec-count').textContent = data.spectrograms || 0;
                    document.getElementById('chainsaw-count').textContent = data.chainsaws || 0;
                })
                .catch(err => {
                    console.warn('Failed to load stats:', err);
                    // Don't reset on network error - keep last values
                });

            // Load LoRa status (always live)
            loadLoraStatus();
        }

        function loadLoraStatus() {
            fetch('/api/lora/status')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('lora-running');
                    const serviceBadge = document.getElementById('lora-service-status');

                    if (data.status === 'running') {
                        badge.innerHTML = '<span class="status-dot"></span>Online';
                        badge.className = 'status-badge online';
                        if (serviceBadge) {
                            serviceBadge.innerHTML = '<span class="status-dot"></span>Active';
                            serviceBadge.className = 'status-badge online';
                        }

                        // Show health warning if needed
                        if (data.health === 'warning' && serviceBadge) {
                            serviceBadge.innerHTML = '<span class="status-dot"></span>Warning';
                            serviceBadge.className = 'status-badge';
                            serviceBadge.style.background = 'rgba(245, 158, 11, 0.2)';
                            serviceBadge.style.color = '#f59e0b';
                        } else if (data.health === 'critical' && serviceBadge) {
                            serviceBadge.innerHTML = '<span class="status-dot"></span>No Data';
                            serviceBadge.className = 'status-badge offline';
                        }
                    } else {
                        badge.innerHTML = '<span class="status-dot"></span>Offline';
                        badge.className = 'status-badge offline';
                        if (serviceBadge) {
                            serviceBadge.innerHTML = '<span class="status-dot"></span>Offline';
                            serviceBadge.className = 'status-badge offline';
                        }
                    }

                    // Update LoRa stats
                    if (data.stats) {
                        const stats = data.stats;
                        document.getElementById('lora-packets').textContent = stats.packets_received || 0;
                        document.getElementById('lora-specs').textContent = stats.spectrograms_saved || 0;

                        if (stats.last_rssi !== undefined && stats.last_rssi !== null) {
                            document.getElementById('lora-rssi').textContent = stats.last_rssi + ' dBm';
                        }
                        if (stats.last_snr !== undefined && stats.last_snr !== null) {
                            document.getElementById('lora-snr').textContent = stats.last_snr + ' dB';
                        }
                    }
                })
                .catch(() => { });
        }

        // Legacy loadStats for compatibility
        function loadStats() {
            loadFilteredStats();
        }

        // Update last update time
        function updateLastUpdateTime() {
            document.getElementById('last-update').textContent = 'Updated ' + new Date().toLocaleTimeString();
        }

        // Load recent spectrograms with date filtering
        function loadSpectrograms() {
            // Build query params based on filter
            let params = new URLSearchParams();
            if (currentViewMode === 'day') {
                params.set('date', currentDate);
            } else if (currentViewMode === 'month') {
                params.set('month', currentMonth);
            } else if (currentViewMode === 'year') {
                params.set('year', currentYear);
            }
            // current mode = no params (today's data)
            const queryString = params.toString() ? '?' + params.toString() : '';

            fetch('/api/spectrograms' + queryString).then(r => r.json()).then(data => {
                const list = document.getElementById('spectrograms-list');
                if (!data || data.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-500"><svg class="w-10 h-10 mx-auto mb-2 opacity-40" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2z"/></svg><p class="text-sm">No spectrograms yet</p><p class="text-xs mt-1">Waiting for node data...</p></div>';
                    return;
                }
                // Filter out invalid entries - require id, node_id, and node_id must be non-empty string
                const validData = data.filter(s => s && s.id && s.node_id && typeof s.node_id === 'string' && s.node_id.trim().length > 0);
                if (validData.length === 0) {
                    list.innerHTML = '<div class="text-center py-8 text-gray-500"><p class="text-sm">No valid spectrograms</p></div>';
                    return;
                }
                list.innerHTML = validData.slice(0, 10).map(s => {
                    const nodeId = s.node_id || 'Unknown';
                    const classification = s.classification || 'Analyzing...';
                    const confidence = s.confidence ? '(' + s.confidence + '%)' : '';
                    const isSelected = selectedSpectrogramId === s.id;
                    return '<div class="list-item ' + (isSelected ? 'ring-2 ring-emerald-500' : '') + '" onclick="showSpectrogram(' + s.id + ')">' +
                        '<div class="flex-1 min-w-0">' +
                        '<div class="flex items-center gap-2 mb-0.5">' +
                        '<span class="list-item-title">' + nodeId + '</span>' +
                        getThreatBadge(s.threat_level) +
                        '</div>' +
                        '<div class="list-item-subtitle truncate">' + classification + ' ' + confidence + '</div>' +
                        '<div class="list-item-meta">' + formatTime(s.timestamp) + '</div>' +
                        '</div>' +
                        '<svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>' +
                        '</div>';
                }).join('');
            }).catch(() => {
                document.getElementById('spectrograms-list').innerHTML = '<div class="text-center py-8 text-gray-500"><p class="text-sm">No spectrograms yet</p></div>';
            });
        }

        function getThreatBadge(level) {
            const badges = {
                'CRITICAL': '<span class="status-badge" style="background:rgba(239,68,68,0.2);color:#ef4444">CRITICAL</span>',
                'HIGH': '<span class="status-badge" style="background:rgba(249,115,22,0.2);color:#f97316">HIGH</span>',
                'MEDIUM': '<span class="status-badge" style="background:rgba(245,158,11,0.2);color:#f59e0b">MEDIUM</span>',
                'LOW': '<span class="status-badge" style="background:rgba(16,185,129,0.2);color:#10b981">LOW</span>'
            };
            return badges[level] || '<span class="status-badge pending"><span class="status-dot"></span>Pending</span>';
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;
            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return date.toLocaleDateString();
        }

        function showSpectrogram(id) {
            selectedSpectrogramId = id;
            loadSpectrograms();

            fetch('/api/spectrograms/' + id).then(r => r.json()).then(s => {
                const preview = document.getElementById('spectrogram-preview');
                const img = document.getElementById('spec-image');
                const analysis = document.getElementById('latest-analysis');

                if (s.image_path) {
                    img.src = '/api/spectrograms/image/' + s.image_path.split('/').pop();
                    img.classList.remove('hidden');
                    const placeholder = preview.querySelector('div');
                    if (placeholder) placeholder.classList.add('hidden');
                }

                const providerBadge = document.getElementById('ai-provider-badge');
                // Check both service_used and ai_provider fields
                const service = s.service_used || s.ai_provider;
                const isOffline = service === 'local_tflite' || service === 'local';
                const hasValidAnalysis = s.classification && s.classification !== 'unknown' && s.confidence > 0;

                if (service === 'gpt4o' || service === 'custom_vision+gpt4o') {
                    providerBadge.textContent = 'GPT-4o Vision';
                    providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-cyan-500/20 text-cyan-400';
                } else if (service === 'custom_vision') {
                    providerBadge.textContent = 'Custom Vision';
                    providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-amber-500/20 text-amber-400';
                } else if (isOffline || (hasValidAnalysis && !service)) {
                    // Show as local if explicitly local OR if has valid analysis but no cloud service recorded
                    providerBadge.textContent = 'Local (Offline)';
                    providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400';
                } else if (!s.classification || s.classification === 'unknown') {
                    providerBadge.textContent = 'Pending';
                    providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-gray-500/20 text-gray-400';
                } else {
                    // Fallback - show the service name if known
                    providerBadge.textContent = service || 'Local (Offline)';
                    providerBadge.className = 'text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400';
                }

                const isChainsaw = s.classification === 'chainsaw';
                const isVehicle = s.classification === 'vehicle';
                const isPending = !s.classification || s.classification === 'unknown' || s.confidence === 0;
                // Check if this was analyzed locally (either explicitly or inferred from missing cloud service)
                const wasAnalyzedLocally = isOffline || (hasValidAnalysis && !service);

                // Choose appropriate icon based on classification
                let iconSvg;
                if (isChainsaw) {
                    // Warning triangle for chainsaw threat
                    iconSvg = '<svg class="w-8 h-8 text-red-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>';
                } else if (isVehicle) {
                    // Vehicle/truck icon
                    iconSvg = '<svg class="w-8 h-8 text-amber-400 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 17h.01M16 17h.01M9 11h6M4 11V8a2 2 0 012-2h3l2-2h2l2 2h3a2 2 0 012 2v3M4 11v4a2 2 0 002 2h1m10 0h1a2 2 0 002-2v-4M4 11h16M7 17a2 2 0 100-4 2 2 0 000 4zm10 0a2 2 0 100-4 2 2 0 000 4z"/></svg>';
                } else {
                    // Tree/forest icon for natural sounds
                    iconSvg = '<svg class="w-8 h-8 text-emerald-400 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L6 10h3v4H6l6 8 6-8h-3v-4h3L12 2z"/></svg>';
                }

                // Show retry button for pending, OR re-analyze with cloud for offline detections
                let actionButton = '';
                if (isPending) {
                    actionButton = '<button onclick="retryAnalysis(' + s.id + ')" class="w-full mt-3 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-sm font-medium transition-colors"><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis</button>';
                } else if (wasAnalyzedLocally) {
                    actionButton = '<button onclick="reanalyzeWithCloud(' + s.id + ')" class="w-full mt-3 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm font-medium transition-colors"><svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>Verify with Cloud AI</button>';
                }

                // Determine box colors based on classification
                let boxBg, boxBorder, textColor;
                if (isChainsaw) {
                    boxBg = 'bg-red-500/10'; boxBorder = 'border-red-500/30'; textColor = 'text-red-400';
                } else if (isVehicle) {
                    boxBg = 'bg-amber-500/10'; boxBorder = 'border-amber-500/30'; textColor = 'text-amber-400';
                } else {
                    boxBg = 'bg-emerald-500/10'; boxBorder = 'border-emerald-500/30'; textColor = 'text-emerald-400';
                }

                analysis.innerHTML = '<div class="space-y-4"><div class="text-center p-4 rounded-lg ' + boxBg + ' border ' + boxBorder + '"><div class="mb-2">' + iconSvg + '</div><div class="text-lg font-bold ' + textColor + '">' + (s.classification || 'Unknown').toUpperCase() + '</div><div class="text-3xl font-bold text-white mt-1">' + (s.confidence || 0) + '%</div>' + getThreatBadge(s.threat_level) + actionButton + '</div><div class="p-3 bg-gray-800/50 rounded-lg"><div class="text-xs text-gray-500 mb-1 font-medium">AI Analysis</div><p class="text-sm text-gray-300 leading-relaxed">' + (s.ai_reasoning || 'Analysis pending...') + '</p></div><div class="grid grid-cols-2 gap-2 text-xs"><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Node</div><div class="font-mono text-white">' + s.node_id + '</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Location</div><div class="font-mono text-white">' + (s.lat ? s.lat.toFixed(4) : '-') + ', ' + (s.lon ? s.lon.toFixed(4) : '-') + '</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">RSSI</div><div class="font-mono text-cyan-400">' + (s.rssi || '-') + ' dBm</div></div><div class="p-2 bg-gray-800/30 rounded"><div class="text-gray-500">Time</div><div class="font-mono text-white">' + new Date(s.timestamp).toLocaleString() + '</div></div></div></div>';
            }).catch(err => console.error('Error loading spectrogram:', err));
        }

        function loadAiMode() {
            fetch('/api/ai/mode').then(r => r.json()).then(data => {
                document.getElementById('current-ai-mode').textContent = getModeLabel(data.mode);
                updateAiModeDesc(data.mode);
                updateAiModeButtons(data.mode);
            }).catch(() => { });

            fetch('/api/ai/status').then(r => r.json()).then(data => {
                const gpt4oStatus = document.getElementById('gpt4o-status');
                const cvStatus = document.getElementById('cv-status');
                if (data.services.gpt4o.configured) {
                    gpt4oStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">Ready</span>';
                    gpt4oStatus.className = 'status-badge online';
                } else {
                    gpt4oStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">N/A</span>';
                    gpt4oStatus.className = 'status-badge offline';
                }
                if (data.services.custom_vision.configured) {
                    cvStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">Ready</span>';
                    cvStatus.className = 'status-badge online';
                } else {
                    cvStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">N/A</span>';
                    cvStatus.className = 'status-badge offline';
                }
                // Local TFLite status
                const localStatus = document.getElementById('local-status');
                if (data.services.local && data.services.local.configured) {
                    localStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">Ready</span>';
                    localStatus.className = 'status-badge online';
                } else {
                    localStatus.innerHTML = '<span class="status-dot"></span><span class="status-text">N/A</span>';
                    localStatus.className = 'status-badge offline';
                }
            }).catch(() => { });
        }

        function updateAiModeDesc(mode) {
            const desc = {
                'gpt4o': 'Detailed analysis with visual reasoning and recommendations',
                'custom_vision': 'Fast classification with your trained model',
                'auto': 'Uses Custom Vision first, verifies threats with GPT-4o',
                'local': 'Local TFLite inference - works offline without cloud'
            };
            document.getElementById('ai-mode-desc').textContent = desc[mode] || 'Select AI service';
        }

        function getModeLabel(mode) {
            const labels = {
                'gpt4o': 'GPT-4o Vision',
                'custom_vision': 'Custom Vision',
                'auto': 'Auto (Hybrid)',
                'local': 'Offline (Local)'
            };
            return labels[mode] || mode;
        }

        function updateAiModeButtons(mode) {
            document.querySelectorAll('.ai-mode-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.mode === mode) {
                    btn.classList.add('active');
                }
            });
        }

        function setAiMode(mode) {
            // Update button states immediately
            updateAiModeButtons(mode);
            document.getElementById('current-ai-mode').textContent = getModeLabel(mode);
            updateAiModeDesc(mode);

            fetch('/api/ai/mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode: mode })
            }).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            }).then(data => {
                if (!data.success) {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                    loadAiMode(); // Reload to restore actual state
                }
            }).catch(err => {
                console.error('AI mode error:', err);
                alert('Error: ' + err.message);
                loadAiMode(); // Reload to restore actual state
            });
        }
        loadAiMode();
        loadLoraStatus();
        updatePeriodDisplay();

        // Fast polling for responsive dashboard
        // Socket.IO events also trigger immediate updates
        setInterval(() => { loadStats(); loadLoraStatus(); updateLastUpdateTime(); }, 3000);
        setInterval(loadSpectrograms, 5000);

        // Socket.IO events (socket declared in app.js)
        socket.on('connect', () => {
            const badge = document.getElementById('connection-status');
            badge.innerHTML = '<span class="status-dot"></span>Live';
            badge.className = 'status-badge online';
        });
        socket.on('disconnect', () => {
            const badge = document.getElementById('connection-status');
            badge.innerHTML = '<span class="status-dot"></span>Offline';
            badge.className = 'status-badge offline';
        });
        socket.on('new_spectrogram', (data) => {
            console.log(' New spectrogram received:', data);
            loadSpectrograms();
            loadStats();
            loadLoraStatus();
        });
        socket.on('spectrogram_analyzed', (data) => {
            console.log(' Spectrogram analyzed:', data);
            loadSpectrograms();
            loadStats();
            loadLoraStatus();
            if (selectedSpectrogramId === data.spectrogram_id) showSpectrogram(data.spectrogram_id);
            if (data.classification === 'chainsaw' && data.confidence >= 70) {
                alert(' CHAINSAW DETECTED!\n\nNode: ' + data.node_id + '\nConfidence: ' + data.confidence + '%');
            }
        });
        socket.on('new_alert', (data) => loadStats());
        socket.on('node_update', (data) => loadStats());
        socket.on('ai_mode_changed', (data) => {
            document.getElementById('current-ai-mode').textContent = getModeLabel(data.mode);
            document.getElementById('ai-mode-select').value = data.mode;
            updateAiModeDesc(data.mode);
        });

        // Retry analysis for pending spectrograms
        function retryAnalysis(specId) {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Analyzing...';

            fetch('/api/spectrograms/' + specId + '/analyze', { method: 'POST' })
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(data => { throw new Error(data.error || 'Analysis failed'); });
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success) {
                        showSpectrogram(specId);
                        loadSpectrograms();
                        loadStats();
                    } else {
                        alert('Analysis failed: ' + (data.error || 'Unknown error'));
                        btn.disabled = false;
                        btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis';
                    }
                })
                .catch(err => {
                    alert('Error: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>Retry Analysis';
                });
        }

        function reanalyzeWithCloud(specId) {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-4 h-4 inline mr-1 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Verifying...';

            // Force cloud analysis (custom_vision or gpt4o based on current settings)
            fetch('/api/spectrograms/' + specId + '/analyze?force_cloud=true', { method: 'POST' })
                .then(r => {
                    if (!r.ok) {
                        return r.json().then(data => { throw new Error(data.error || 'Cloud verification failed'); });
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success) {
                        showSpectrogram(specId);
                        loadSpectrograms();
                        loadStats();
                        // Show a quick toast notification
                        const toast = document.createElement('div');
                        toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-pulse';
                        toast.innerHTML = ' Cloud verification complete';
                        document.body.appendChild(toast);
                        setTimeout(() => toast.remove(), 3000);
                    } else {
                        alert('Cloud verification failed: ' + (data.error || 'Unknown error'));
                        btn.disabled = false;
                        btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>Verify with Cloud AI';
                    }
                })
                .catch(err => {
                    alert('Error: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>Verify with Cloud AI';
                });
        }

        // ============================================
        // SYNC STATUS AND MANUAL SYNC
        // ============================================
        function loadSyncStatus() {
            fetch('/api/sync/status').then(r => r.json()).then(data => {
                if (data.success) {
                    const pendingCount = data.queue?.pending || 0;
                    const syncStatus = document.getElementById('sync-status');
                    const pendingEl = document.getElementById('sync-pending-count');

                    pendingEl.textContent = pendingCount;

                    if (!data.is_online) {
                        syncStatus.className = 'status-badge offline';
                        syncStatus.innerHTML = '<span class="status-dot"></span>Offline';
                    } else if (pendingCount > 0) {
                        syncStatus.className = 'status-badge warning';
                        syncStatus.innerHTML = '<span class="status-dot"></span><span id="sync-pending-count">' + pendingCount + '</span> pending';
                    } else {
                        syncStatus.className = 'status-badge online';
                        syncStatus.innerHTML = '<span class="status-dot"></span>Synced';
                    }

                    // Update sync button visibility/state
                    const syncBtn = document.getElementById('manual-sync-btn');
                    if (pendingCount > 0 && data.is_online) {
                        syncBtn.style.display = 'flex';
                        syncBtn.disabled = false;
                    } else if (pendingCount === 0) {
                        syncBtn.style.display = 'none';
                    } else {
                        syncBtn.style.display = 'flex';
                        syncBtn.disabled = true;
                    }
                }
            }).catch(() => {
                // Sync module might not be available
                document.getElementById('sync-status').innerHTML = '<span class="status-dot"></span>N/A';
                document.getElementById('manual-sync-btn').style.display = 'none';
            });
        }

        function triggerManualSync() {
            const btn = document.getElementById('manual-sync-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> Syncing...';

            fetch('/api/sync/trigger', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Synced ' + data.items_synced + ' items';
                        loadSyncStatus();
                        loadSpectrograms();
                        loadStats();
                    } else {
                        btn.innerHTML = ' ' + (data.error || 'Sync failed');
                    }
                    setTimeout(() => {
                        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Sync Now';
                        btn.disabled = false;
                        loadSyncStatus();
                    }, 3000);
                })
                .catch(err => {
                    btn.innerHTML = ' Error';
                    setTimeout(() => {
                        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Sync Now';
                        btn.disabled = false;
                    }, 3000);
                });
        }

        // Load sync status periodically
        loadSyncStatus();
        setInterval(loadSyncStatus, 10000);

        // Handle sync completed socket event
        socket.on('sync_completed', (data) => {
            console.log(' Sync completed:', data);
            loadSyncStatus();
            loadSpectrograms();
            loadStats();
        });
    </script>
    {% endblock %}