{% extends 'base.html' %}
{% block content %}
<!-- Page Header -->
<div class="page-header-responsive">
    <div>
        <h1 class="page-title-text">
            <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
            </svg>
            <span>Nodes</span>
        </h1>
        <p class="page-subtitle">Forest protection network</p>
    </div>
    <div class="flex items-center gap-2">
        <span class="text-sm text-gray-400">
            <span id="online-count" class="text-emerald-400 font-bold">0</span> / <span id="total-count">0</span> online
        </span>
    </div>
</div>

<style>
    .page-header-responsive {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .page-title-text {
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .page-subtitle {
        color: #9ca3af;
        font-size: 0.8125rem;
        margin-top: 0.125rem;
    }

    /* Nodes Grid Responsive */
    #nodes-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    @media screen and (max-width: 1024px) {
        #nodes-container {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media screen and (max-width: 800px) {
        .page-header-responsive {
            margin-bottom: 0.75rem;
        }

        .page-title-text {
            font-size: 1.125rem;
        }

        .page-title-text svg {
            width: 20px;
            height: 20px;
        }

        .page-subtitle {
            display: none;
        }

        #nodes-container {
            grid-template-columns: 1fr;
            gap: 0.75rem;
        }

        #nodes-container .card {
            padding: 0.875rem;
        }

        #nodes-container .card .p-5 {
            padding: 0 !important;
        }

        #nodes-container .w-12 {
            width: 2.5rem;
            height: 2.5rem;
        }

        #nodes-container .w-12 svg {
            width: 1.25rem;
            height: 1.25rem;
        }
    }

    @media screen and (max-width: 480px) {
        #nodes-container {
            gap: 0.5rem;
        }

        #nodes-container .card {
            padding: 0.75rem;
        }
    }

    /* Landscape mode for 5" display */
    @media screen and (max-width: 800px) and (max-height: 480px) and (orientation: landscape) {
        #nodes-container {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
    }
</style>

<!-- Nodes Grid -->
<div id="nodes-container">
    {% for n in nodes %}
    <div class="card hover:border-gray-600 transition-colors">
        <div class="p-5">
            <!-- Node Header -->
            <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 rounded-lg bg-emerald-500/20 flex items-center justify-center">
                        <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-semibold text-white">{{ n.node_id }}</h3>
                        <span class="text-xs text-gray-500">{{ n.hardware or 'ESP32-S3' }}</span>
                    </div>
                </div>
                {% if n.status == 'online' %}
                <span class="status-badge online">
                    <span class="status-dot"></span>
                    Online
                </span>
                {% else %}
                <span class="status-badge offline">
                    <span class="status-dot"></span>
                    Offline
                </span>
                {% endif %}
            </div>

            <!-- Node Stats -->
            <div class="space-y-3">
                <!-- Battery -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            {% if n.battery > 80 %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8V7a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1v-1m2-4h2m-2-4h2m-2 8h2" />
                            <rect x="4" y="8" width="12" height="8" fill="currentColor" opacity="0.3" />
                            {% elif n.battery > 50 %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8V7a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1v-1m2-4h2m-2-4h2m-2 8h2" />
                            <rect x="4" y="8" width="8" height="8" fill="currentColor" opacity="0.3" />
                            {% elif n.battery > 20 %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8V7a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1v-1m2-4h2m-2-4h2m-2 8h2" />
                            <rect x="4" y="8" width="4" height="8" fill="currentColor" opacity="0.3" />
                            {% else %}
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 8V7a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h12a1 1 0 001-1v-1m2-4h2m-2-4h2m-2 8h2" />
                            {% endif %}
                        </svg>
                        Battery
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-20 h-2 bg-gray-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full {% if n.battery > 50 %}bg-emerald-500{% elif n.battery > 20 %}bg-yellow-500{% else %}bg-red-500{% endif %}"
                                style="width: {{ n.battery }}%"></div>
                        </div>
                        <span
                            class="text-sm font-mono {% if n.battery > 50 %}text-emerald-400{% elif n.battery > 20 %}text-yellow-400{% else %}text-red-400{% endif %}">{{
                            n.battery }}%</span>
                    </div>
                </div>

                <!-- Location -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        Location
                    </div>
                    <span class="text-sm font-mono text-white">{{ "%.4f"|format(n.lat) }}, {{ "%.4f"|format(n.lon)
                        }}</span>
                </div>

                <!-- Last Seen -->
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Last Seen
                    </div>
                    <span class="text-sm text-gray-300">{{ n.last_seen }}</span>
                </div>

                <!-- RSSI (if available) -->
                {% if n.rssi %}
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 text-gray-400 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0M1.394 9.393c5.857-5.857 15.355-5.857 21.213 0" />
                        </svg>
                        Signal
                    </div>
                    <span class="text-sm font-mono text-cyan-400">{{ n.rssi }} dBm</span>
                </div>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="mt-4 pt-4 border-t border-gray-800 flex gap-2">
                <button onclick="locateNode('{{ n.node_id }}', {{ n.lat }}, {{ n.lon }})"
                    class="btn btn-secondary flex-1 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                    </svg>
                    View on Map
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if not nodes %}
<div class="text-center py-16 text-gray-500">
    <svg class="w-16 h-16 mx-auto mb-4 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
    </svg>
    <p class="text-lg font-medium">No nodes registered</p>
    <p class="text-sm mt-1">Nodes will appear here once they connect to the hub</p>
</div>
{% endif %}

<script>
    function locateNode(nodeId, lat, lon) {
        window.location.href = `/map?node=${nodeId}&lat=${lat}&lon=${lon}`;
    }

    // Update counts
    document.addEventListener('DOMContentLoaded', () => {
        const nodes = document.querySelectorAll('.card');
        const onlineNodes = document.querySelectorAll('.status-badge.online');
        document.getElementById('total-count').textContent = nodes.length;
        document.getElementById('online-count').textContent = onlineNodes.length;
    });

    // Real-time updates (socket declared in app.js)
    socket.on('node_update', () => {
        location.reload();
    });
</script>
{% endblock %}