{% extends 'base.html' %}
{% block content %}
<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="text-2xl font-bold text-white flex items-center gap-3">
            <svg class="w-7 h-7 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
            </svg>
            Live Map
        </h1>
        <p class="text-gray-400 text-sm mt-1">Real-time view of nodes and alerts</p>
    </div>
    <div class="flex items-center gap-3">
        <!-- Map Legend -->
        <div class="flex items-center gap-4 text-sm">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                <span class="text-gray-400">Nodes</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-gray-400">Alerts</span>
            </div>
        </div>
        <button id="center-map" class="btn btn-secondary text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
            </svg>
            Center
        </button>
    </div>
</div>

<!-- Map Container -->
<div class="card overflow-hidden relative">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <div id="map" class="w-full h-[600px]"></div>
    <!-- Empty state overlay -->
    <div id="empty-state"
        class="absolute inset-0 flex items-center justify-center bg-gray-900/80 hidden pointer-events-none">
        <div class="text-center">
            <svg class="w-12 h-12 text-gray-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p class="text-gray-400">No nodes with valid GPS coordinates</p>
            <p class="text-gray-500 text-sm mt-1">Waiting for GPS lock on guardian nodes...</p>
        </div>
    </div>
</div>

<!-- Info Panel -->
<div id="info-panel" class="fixed bottom-6 right-6 w-80 card hidden z-[1000]">
    <div class="p-4">
        <div class="flex items-center justify-between mb-3">
            <h3 id="panel-title" class="font-semibold text-white">Details</h3>
            <button id="close-panel" class="text-gray-400 hover:text-white">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        <div id="panel-content" class="text-sm text-gray-300">
            <!-- Dynamic content -->
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Initialize map
    const map = L.map('map').setView([43.65, -79.38], 10);

    // Dark mode tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
    }).addTo(map);

    // Custom icons
    const nodeIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div class="w-8 h-8 bg-emerald-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
            </svg>
        </div>`,
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    const alertIcon = L.divIcon({
        className: 'custom-marker',
        html: `<div class="w-10 h-10 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center animate-pulse">
            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
        </div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 20]
    });

    // Marker storage
    const nodeMarkers = [];
    const alertMarkers = [];

    // Info panel functions
    const infoPanel = document.getElementById('info-panel');
    const panelTitle = document.getElementById('panel-title');
    const panelContent = document.getElementById('panel-content');

    function showNodeInfo(node) {
        panelTitle.textContent = node.node_id;
        const isOnline = node.status === 'online' || node.status === 'active';
        const lastSeen = node.last_seen ? new Date(node.last_seen).toLocaleString() : 'Unknown';
        panelContent.innerHTML = `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-400">Status</span>
                    <span class="status-badge ${isOnline ? 'online' : 'offline'}">
                        <span class="status-dot"></span>
                        ${isOnline ? 'Online' : 'Offline'}
                    </span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Battery</span>
                    <span class="${node.battery > 50 ? 'text-emerald-400' : node.battery > 20 ? 'text-yellow-400' : 'text-red-400'}">${node.battery || 0}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Location</span>
                    <span class="font-mono">${(node.lat || 0).toFixed(4)}, ${(node.lon || 0).toFixed(4)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Signal</span>
                    <span class="${node.rssi > -70 ? 'text-emerald-400' : node.rssi > -90 ? 'text-yellow-400' : 'text-red-400'}">${node.rssi || 0} dBm</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Last Seen</span>
                    <span>${lastSeen}</span>
                </div>
            </div>
            <a href="/nodes" class="btn btn-secondary w-full mt-4 text-center text-sm">View All Nodes</a>
        `;
        infoPanel.classList.remove('hidden');
    }

    function showAlertInfo(alert) {
        panelTitle.textContent = 'Alert #' + alert.id;
        const date = new Date(alert.timestamp);
        panelContent.innerHTML = `
            <div class="space-y-2">
                <div class="flex justify-between">
                    <span class="text-gray-400">Node</span>
                    <span class="font-semibold">${alert.node_id}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Confidence</span>
                    <span class="${alert.confidence >= 70 ? 'text-red-400' : 'text-yellow-400'} font-bold">${alert.confidence}%</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Location</span>
                    <span class="font-mono">${(alert.lat || 0).toFixed(4)}, ${(alert.lon || 0).toFixed(4)}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Time</span>
                    <span>${date.toLocaleString()}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Status</span>
                    <span class="status-badge ${alert.responded ? 'online' : 'offline'}">
                        <span class="status-dot"></span>
                        ${alert.responded ? 'Responded' : 'Pending'}
                    </span>
                </div>
            </div>
            <a href="/alerts" class="btn btn-primary w-full mt-4 text-center text-sm">View All Alerts</a>
        `;
        infoPanel.classList.remove('hidden');
    }

    document.getElementById('close-panel').addEventListener('click', () => {
        infoPanel.classList.add('hidden');
    });

    // Helper to check if coordinates are valid (not placeholder values)
    function isValidCoords(lat, lon) {
        // Check if coords exist and are not near 0,0 (placeholder values)
        if (!lat || !lon) return false;
        // Reject coordinates very close to 0,0 (likely placeholder)
        if (Math.abs(lat) < 1 && Math.abs(lon) < 1) return false;
        // Reject out of range coordinates
        if (lat < -90 || lat > 90 || lon < -180 || lon > 180) return false;
        return true;
    }

    // Load nodes
    function loadNodes() {
        fetch('/api/nodes').then(r => r.json()).then(nodes => {
            // Clear existing markers
            nodeMarkers.forEach(m => map.removeLayer(m));
            nodeMarkers.length = 0;

            let validNodes = [];
            nodes.forEach(n => {
                if (isValidCoords(n.lat, n.lon)) {
                    const marker = L.marker([n.lat, n.lon], { icon: nodeIcon })
                        .addTo(map)
                        .on('click', () => showNodeInfo(n));

                    marker.bindTooltip(n.node_id, {
                        permanent: false,
                        direction: 'top',
                        className: 'bg-gray-900 text-white border-gray-700 px-2 py-1 rounded text-xs'
                    });

                    nodeMarkers.push(marker);
                    validNodes.push(n);
                }
            });

            // Center map on first valid node if available
            if (validNodes.length > 0) {
                map.setView([validNodes[0].lat, validNodes[0].lon], 12);
            }

            // Update empty state visibility
            updateEmptyState();
        }).catch(err => console.error('Error loading nodes:', err));
    }

    // Load alerts - group nearby alerts together
    function loadAlerts() {
        fetch('/api/alerts?unresponded=true').then(r => r.json()).then(alerts => {
            // Clear existing markers
            alertMarkers.forEach(m => map.removeLayer(m));
            alertMarkers.length = 0;

            // Filter valid coordinates
            const validAlerts = alerts.filter(a => isValidCoords(a.lat, a.lon));

            // Group alerts by approximate location (within ~100m)
            const grouped = groupAlertsByLocation(validAlerts, 0.001); // ~100m at equator

            grouped.forEach(group => {
                const count = group.alerts.length;
                const latest = group.alerts[0]; // Already sorted by timestamp desc
                const maxConfidence = Math.max(...group.alerts.map(a => a.confidence));

                // Create custom icon with count badge if multiple
                const iconHtml = count > 1
                    ? `<div class="relative">
                        <div class="w-10 h-10 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center animate-pulse">
                            <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div class="absolute -top-1 -right-1 w-5 h-5 bg-yellow-400 text-gray-900 rounded-full text-xs font-bold flex items-center justify-center">${count}</div>
                    </div>`
                    : `<div class="w-10 h-10 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center animate-pulse">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>`;

                const groupIcon = L.divIcon({
                    className: 'custom-marker',
                    html: iconHtml,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });

                const marker = L.marker([group.lat, group.lon], { icon: groupIcon })
                    .addTo(map)
                    .on('click', () => {
                        if (count > 1) {
                            showGroupedAlertInfo(group.alerts);
                        } else {
                            showAlertInfo(latest);
                        }
                    });

                const tooltipText = count > 1
                    ? `${count} alerts (max ${maxConfidence}%)`
                    : `Alert: ${latest.confidence}%`;

                marker.bindTooltip(tooltipText, {
                    permanent: false,
                    direction: 'top',
                    className: 'bg-red-900 text-white border-red-700 px-2 py-1 rounded text-xs'
                });

                alertMarkers.push(marker);
            });

            // Update empty state visibility
            updateEmptyState();
        }).catch(err => console.error('Error loading alerts:', err));
    }

    // Group alerts by location proximity
    function groupAlertsByLocation(alerts, threshold) {
        const groups = [];
        const used = new Set();

        alerts.forEach((alert, i) => {
            if (used.has(i)) return;

            const group = {
                lat: alert.lat,
                lon: alert.lon,
                alerts: [alert]
            };
            used.add(i);

            // Find nearby alerts
            alerts.forEach((other, j) => {
                if (used.has(j)) return;
                const dist = Math.sqrt(
                    Math.pow(alert.lat - other.lat, 2) +
                    Math.pow(alert.lon - other.lon, 2)
                );
                if (dist < threshold) {
                    group.alerts.push(other);
                    used.add(j);
                }
            });

            groups.push(group);
        });

        return groups;
    }

    // Show info panel for grouped alerts
    function showGroupedAlertInfo(alerts) {
        panelTitle.textContent = `${alerts.length} Alerts at Location`;
        let alertsList = alerts.slice(0, 5).map(a => {
            const date = new Date(a.timestamp);
            return `<div class="flex justify-between py-1 border-b border-gray-700">
                <span class="text-gray-400">#${a.id}</span>
                <span class="${a.confidence >= 70 ? 'text-red-400' : 'text-yellow-400'} font-bold">${a.confidence}%</span>
                <span class="text-xs text-gray-500">${date.toLocaleTimeString()}</span>
            </div>`;
        }).join('');

        if (alerts.length > 5) {
            alertsList += `<div class="text-center text-gray-500 text-sm mt-2">+${alerts.length - 5} more...</div>`;
        }

        panelContent.innerHTML = `
            <div class="space-y-1 max-h-48 overflow-y-auto">
                ${alertsList}
            </div>
            <div class="flex justify-between mt-3 pt-2 border-t border-gray-700">
                <span class="text-gray-400">Node</span>
                <span class="font-semibold">${alerts[0].node_id}</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-400">Location</span>
                <span class="font-mono text-xs">${alerts[0].lat.toFixed(4)}, ${alerts[0].lon.toFixed(4)}</span>
            </div>
            <a href="/alerts" class="btn btn-primary w-full mt-4 text-center text-sm">View All Alerts</a>
        `;
        infoPanel.classList.remove('hidden');
    }

    // Show/hide empty state based on markers
    function updateEmptyState() {
        const emptyState = document.getElementById('empty-state');
        if (nodeMarkers.length === 0 && alertMarkers.length === 0) {
            emptyState.classList.remove('hidden');
        } else {
            emptyState.classList.add('hidden');
        }
    }

    // Center map on all markers
    document.getElementById('center-map').addEventListener('click', () => {
        const allMarkers = [...nodeMarkers, ...alertMarkers];
        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds().pad(0.1));
        }
    });

    // Check URL params for focusing on specific node
    const urlParams = new URLSearchParams(window.location.search);
    const focusLat = urlParams.get('lat');
    const focusLon = urlParams.get('lon');
    if (focusLat && focusLon) {
        map.setView([parseFloat(focusLat), parseFloat(focusLon)], 15);
    }

    // Initial load
    loadNodes();
    loadAlerts();

    // Real-time updates (socket declared in app.js)
    socket.on('node_update', () => loadNodes());
    socket.on('new_alert', () => loadAlerts());

    // Refresh every 30 seconds
    setInterval(() => {
        loadNodes();
        loadAlerts();
    }, 30000);
</script>

<style>
    .custom-marker {
        background: transparent;
        border: none;
    }

    .leaflet-tooltip {
        background: #1f2937;
        color: white;
        border: 1px solid #374151;
        border-radius: 4px;
        padding: 4px 8px;
        font-size: 12px;
    }

    .leaflet-tooltip-top:before {
        border-top-color: #374151;
    }
</style>
{% endblock %}